<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Golf Trip Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: light dark;
    }
    body {
      margin: 0;
      background: #0b1520;
      color: #f5f5f5;
    }
    .app {
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 280px;
      background: radial-gradient(circle at top left, #123, #020712);
      border-right: 1px solid rgba(255, 255, 255, 0.08);
      padding: 1rem;
      box-sizing: border-box;
    }
    .sidebar h1 {
      font-size: 1.2rem;
      margin: 0 0 0.5rem;
    }
    .sidebar small {
      display: block;
      margin-bottom: 1rem;
      color: #a0aec0;
    }
    .trip-list {
      margin-top: 0.5rem;
      max-height: calc(100vh - 180px);
      overflow-y: auto;
    }
    .trip-item {
      padding: 0.5rem 0.6rem;
      margin-bottom: 0.35rem;
      border-radius: 0.5rem;
      cursor: pointer;
      border: 1px solid transparent;
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }
    .trip-item span.name {
      font-weight: 600;
      font-size: 0.9rem;
    }
    .trip-item span.meta {
      font-size: 0.75rem;
      color: #cbd5f5;
    }
    .trip-item.active {
      background: linear-gradient(135deg, #0d3b66, #1a6f4d);
      border-color: rgba(255, 255, 255, 0.2);
    }
    .btn {
      padding: 0.4rem 0.7rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #021218;
      box-shadow: 0 0 0 1px rgba(15, 118, 110, 0.5),
                  0 6px 18px rgba(22, 163, 74, 0.55);
    }
    .btn-secondary {
      background: transparent;
      color: #e2e8f0;
      border: 1px solid rgba(148, 163, 184, 0.6);
      box-shadow: none;
    }
    .btn-danger {
      background: transparent;
      color: #fecaca;
      border: 1px solid rgba(248, 113, 113, 0.8);
      box-shadow: none;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }
    .sidebar-footer {
      position: sticky;
      bottom: 0;
      padding-top: 0.75rem;
      margin-top: 0.75rem;
      border-top: 1px solid rgba(148, 163, 184, 0.4);
      background: radial-gradient(circle at bottom left, #020617, #020617);
    }

    .main {
      flex: 1;
      padding: 1rem 1.5rem 2rem;
      box-sizing: border-box;
      overflow-y: auto;
      background: radial-gradient(circle at top, #0f172a, #020617);
    }
    .main-header {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 1rem;
    }
    .main-header-left h2 {
      margin: 0;
      font-size: 1.3rem;
    }
    .main-header-left p {
      margin: 0.25rem 0 0;
      font-size: 0.85rem;
      color: #a0aec0;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: #e2e8f0;
    }
    .pill span.dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 2fr);
      gap: 1rem;
      margin-bottom: 1rem;
    }
    @media (max-width: 960px) {
      .app {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid rgba(148, 163, 184, 0.5);
      }
      .main {
        padding: 1rem;
      }
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.98));
      border-radius: 1rem;
      padding: 0.85rem 1rem 1rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.7);
    }
    .card h3 {
      margin: 0 0 0.5rem;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }
    .card h3 span.label {
      font-weight: 600;
    }
    .card h3 span.sub {
      font-size: 0.8rem;
      font-weight: 400;
      color: #a0aec0;
    }
    .card small.help {
      display: block;
      margin-top: 0.35rem;
      color: #94a3b8;
      font-size: 0.75rem;
    }

    .field-row {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.4rem;
      flex-wrap: wrap;
    }
    .field {
      flex: 1;
      min-width: 110px;
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }
    label {
      font-size: 0.75rem;
      color: #cbd5e1;
    }
    input, textarea, select {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 0.5rem;
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 0.35rem 0.5rem;
      font-size: 0.8rem;
      color: #f1f5f9;
      outline: none;
    }
    input:focus, textarea:focus, select:focus {
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.3);
    }
    textarea {
      min-height: 70px;
      resize: vertical;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
      margin-top: 0.25rem;
    }
    th, td {
      border-bottom: 1px solid rgba(51, 65, 85, 0.9);
      padding: 0.25rem 0.35rem;
      text-align: left;
    }
    th {
      font-weight: 600;
      color: #e2e8f0;
      background: rgba(15, 23, 42, 0.85);
      position: sticky;
      top: 0;
    }
    tr:last-child td {
      border-bottom: none;
    }
    .table-scroll {
      max-height: 210px;
      overflow-y: auto;
      margin-top: 0.25rem;
      border-radius: 0.5rem;
      border: 1px solid rgba(30, 64, 175, 0.7);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 1));
    }

    .badge {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 0.1rem 0.45rem;
      font-size: 0.7rem;
      border: 1px solid rgba(56, 189, 248, 0.7);
      color: #e0f2fe;
      margin-left: auto;
    }

    .summary-line {
      display: flex;
      justify-content: space-between;
      font-size: 0.82rem;
      margin: 0.1rem 0;
    }
    .summary-line span.label {
      color: #cbd5e1;
    }
    .summary-line span.value {
      font-weight: 600;
    }
    .summary-total {
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px dashed rgba(148, 163, 184, 0.7);
    }

    .empty-state {
      margin-top: 2rem;
      text-align: center;
      color: #94a3b8;
      font-size: 0.9rem;
    }

    .scoreboard-table td, .scoreboard-table th {
      border-bottom: 1px solid rgba(51, 65, 85, 0.9);
    }
  </style>

  <!-- React / ReactDOM / Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
  const { useState, useEffect, useMemo } = React;

  const STORAGE_KEY = "golfTripPlannerTrips_v2";

  function loadTripsFromStorage() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed)) return [];
      // Ensure new fields exist
      return parsed.map((t) => ({
        players: [],
        rounds: [],
        lodging: [],
        teams: [],
        scores: {},
        ...t
      }));
    } catch (e) {
      console.error("Failed to load trips", e);
      return [];
    }
  }

  function saveTripsToStorage(trips) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(trips));
    } catch (e) {
      console.error("Failed to save trips", e);
    }
  }

  function createNewTrip() {
    const id = Date.now().toString();
    return {
      id,
      name: "New Golf Trip",
      destination: "",
      startDate: "",
      endDate: "",
      notes: "",
      players: [],
      rounds: [],
      lodging: [],
      teams: [],
      scores: {} // scores[roundId][playerId] = { strokes: "72" }
    };
  }

  // Simple CSV helper
  function downloadCSV(filename, headers, rows) {
    const escape = (value) => {
      if (value == null) return "";
      const s = String(value);
      if (s.includes('"') || s.includes(",") || s.includes("\n")) {
        return '"' + s.replace(/"/g, '""') + '"';
      }
      return s;
    };

    const headerLine = headers.map(escape).join(",");
    const bodyLines = rows.map((row) =>
      headers.map((h) => escape(row[h])).join(",")
    );
    const csv = [headerLine, ...bodyLines].join("\n");

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }

  function downloadJSON(filename, data) {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }

  function Sidebar({ trips, selectedId, onSelectTrip, onAddTrip, onDeleteTrip }) {
    return (
      <aside className="sidebar">
        <h1>Golf Trip Planner</h1>
        <small>Plan, track, and budget all your golf trips in one place.</small>

        <button className="btn" onClick={onAddTrip}>
          <span>Ôºã</span> New Trip
        </button>

        <div className="trip-list">
          {trips.map((trip) => {
            const isActive = trip.id === selectedId;
            const dateLabel = (trip.startDate || trip.endDate)
              ? `${trip.startDate || "?"} ‚Üí ${trip.endDate || "?"}`
              : "Dates TBD";
            return (
              <div
                key={trip.id}
                className={"trip-item" + (isActive ? " active" : "")}
                onClick={() => onSelectTrip(trip.id)}
              >
                <span className="name">{trip.name || "Untitled Trip"}</span>
                <span className="meta">
                  {trip.destination || "Destination TBA"} ¬∑ {dateLabel}
                </span>
                {isActive && (
                  <button
                    className="btn-danger"
                    style={{ marginTop: "0.2rem", alignSelf: "flex-start" }}
                    onClick={(e) => {
                      e.stopPropagation();
                      if (confirm("Delete this trip? This cannot be undone.")) {
                        onDeleteTrip(trip.id);
                      }
                    }}
                  >
                    üóë Delete
                  </button>
                )}
              </div>
            );
          })}

          {trips.length === 0 && (
            <p style={{ marginTop: "1rem", fontSize: "0.85rem", color: "#94a3b8" }}>
              No trips yet. Click <strong>New Trip</strong> to get started.
            </p>
          )}
        </div>

        <div className="sidebar-footer">
          <div style={{ fontSize: "0.75rem", color: "#64748b" }}>
            Pro tip: create one trip per buddies trip (e.g. ‚ÄúForest Dunes 2026‚Äù) and duplicate
            it as a template for future years.
          </div>
        </div>
      </aside>
    );
  }

  function BasicInfo({ trip, onChange }) {
    function update(field, value) {
      onChange({ ...trip, [field]: value });
    }

    return (
      <div className="card">
        <h3>
          <span className="label">Trip Overview</span>
          <span className="sub">High-level details</span>
        </h3>

        <div className="field-row">
          <div className="field">
            <label>Trip Name</label>
            <input
              value={trip.name}
              onChange={(e) => update("name", e.target.value)}
              placeholder="Forest Dunes 2026"
            />
          </div>
          <div className="field">
            <label>Destination / Region</label>
            <input
              value={trip.destination}
              onChange={(e) => update("destination", e.target.value)}
              placeholder="Roscommon, MI"
            />
          </div>
        </div>

        <div className="field-row">
          <div className="field">
            <label>Start Date</label>
            <input
              type="date"
              value={trip.startDate}
              onChange={(e) => update("startDate", e.target.value)}
            />
          </div>
          <div className="field">
            <label>End Date</label>
            <input
              type="date"
              value={trip.endDate}
              onChange={(e) => update("endDate", e.target.value)}
            />
          </div>
        </div>

        <div className="field-row">
          <div className="field">
            <label>Trip Notes</label>
            <textarea
              value={trip.notes}
              onChange={(e) => update("notes", e.target.value)}
              placeholder="7 guys, 4 rounds, splitting cabins, note rain backup plans, etc."
            />
          </div>
        </div>
      </div>
    );
  }

  function PlayersCard({ trip, onChange }) {
    const players = trip.players || [];

    function addPlayer() {
      const id = Date.now().toString() + Math.random().toString(16).slice(2);
      const updated = {
        ...trip,
        players: [
          ...players,
          { id, name: "", handicap: "", email: "", notes: "" }
        ]
      };
      onChange(updated);
    }

    function updatePlayer(id, field, value) {
      const updatedPlayers = players.map((p) =>
        p.id === id ? { ...p, [field]: value } : p
      );
      onChange({ ...trip, players: updatedPlayers });
    }

    function removePlayer(id) {
      const updatedPlayers = players.filter((p) => p.id !== id);
      onChange({ ...trip, players: updatedPlayers });
    }

    return (
      <div className="card">
        <h3>
          <span className="label">Players</span>
          <span className="sub">{players.length} in this trip</span>
        </h3>

        <button className="btn-secondary" onClick={addPlayer}>
          Ôºã Add Player
        </button>

        <div className="table-scroll">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Index / HC</th>
                <th>Email</th>
                <th>Notes</th>
                <th />
              </tr>
            </thead>
            <tbody>
              {players.map((p) => (
                <tr key={p.id}>
                  <td>
                    <input
                      value={p.name}
                      onChange={(e) => updatePlayer(p.id, "name", e.target.value)}
                      placeholder="Player name"
                    />
                  </td>
                  <td>
                    <input
                      value={p.handicap}
                      onChange={(e) =>
                        updatePlayer(p.id, "handicap", e.target.value)
                      }
                      placeholder="e.g. 8.2"
                    />
                  </td>
                  <td>
                    <input
                      value={p.email}
                      onChange={(e) => updatePlayer(p.id, "email", e.target.value)}
                      placeholder="optional"
                    />
                  </td>
                  <td>
                    <input
                      value={p.notes}
                      onChange={(e) => updatePlayer(p.id, "notes", e.target.value)}
                      placeholder="preferences, room pairings..."
                    />
                  </td>
                  <td>
                    <button
                      className="btn-danger"
                      onClick={() => removePlayer(p.id)}
                    >
                      ‚úï
                    </button>
                  </td>
                </tr>
              ))}
              {players.length === 0 && (
                <tr>
                  <td colSpan="5" style={{ textAlign: "center", color: "#94a3b8" }}>
                    Add your first player to start building your group.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
        <small className="help">
          Use this list for room assignments, tee-time pairings, and budgeting per person.
        </small>
      </div>
    );
  }

  function RoundsCard({ trip, onChange }) {
    const rounds = trip.rounds || [];

    function addRound() {
      const id = Date.now().toString() + Math.random().toString(16).slice(2);
      const updated = {
        ...trip,
        rounds: [
          ...rounds,
          { id, date: "", course: "", teeTime: "", greenFee: "" }
        ]
      };
      onChange(updated);
    }

    function updateRound(id, field, value) {
      const updatedRounds = rounds.map((r) =>
        r.id === id ? { ...r, [field]: value } : r
      );
      onChange({ ...trip, rounds: updatedRounds });
    }

    function removeRound(id) {
      const updatedRounds = rounds.filter((r) => r.id !== id);
      onChange({ ...trip, rounds: updatedRounds });
    }

    return (
      <div className="card">
        <h3>
          <span className="label">Rounds & Tee Times</span>
          <span className="sub">Courses and green fees</span>
        </h3>

        <button className="btn-secondary" onClick={addRound}>
          Ôºã Add Round
        </button>

        <div className="table-scroll">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Course</th>
                <th>Tee Time</th>
                <th>Green Fee ($)</th>
                <th />
              </tr>
            </thead>
            <tbody>
              {rounds.map((r) => (
                <tr key={r.id}>
                  <td>
                    <input
                      type="date"
                      value={r.date}
                      onChange={(e) => updateRound(r.id, "date", e.target.value)}
                    />
                  </td>
                  <td>
                    <input
                      value={r.course}
                      onChange={(e) =>
                        updateRound(r.id, "course", e.target.value)
                      }
                      placeholder="Course name"
                    />
                  </td>
                  <td>
                    <input
                      value={r.teeTime}
                      onChange={(e) =>
                        updateRound(r.id, "teeTime", e.target.value)
                      }
                      placeholder="e.g. 8:12 AM"
                    />
                  </td>
                  <td>
                    <input
                      type="number"
                      min="0"
                      step="1"
                      value={r.greenFee}
                      onChange={(e) =>
                        updateRound(r.id, "greenFee", e.target.value)
                      }
                      placeholder="0"
                    />
                  </td>
                  <td>
                    <button
                      className="btn-danger"
                      onClick={() => removeRound(r.id)}
                    >
                      ‚úï
                    </button>
                  </td>
                </tr>
              ))}
              {rounds.length === 0 && (
                <tr>
                  <td colSpan="5" style={{ textAlign: "center", color: "#94a3b8" }}>
                    Add each planned round with an estimated green fee.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
        <small className="help">
          Include replay rates, twilight rounds, and add 0 for comped rounds if needed.
        </small>
      </div>
    );
  }

  function LodgingCard({ trip, onChange }) {
    const lodging = trip.lodging || [];

    function addNight() {
      const id = Date.now().toString() + Math.random().toString(16).slice(2);
      const updated = {
        ...trip,
        lodging: [
          ...lodging,
          { id, date: "", place: "", cost: "" }
        ]
      };
      onChange(updated);
    }

    function updateNight(id, field, value) {
      const updatedLodging = lodging.map((n) =>
        n.id === id ? { ...n, [field]: value } : n
      );
      onChange({ ...trip, lodging: updatedLodging });
    }

    function removeNight(id) {
      const updatedLodging = lodging.filter((n) => n.id !== id);
      onChange({ ...trip, lodging: updatedLodging });
    }

    return (
      <div className="card">
        <h3>
          <span className="label">Lodging</span>
          <span className="sub">Cabins, hotels, and rentals</span>
        </h3>

        <button className="btn-secondary" onClick={addNight}>
          Ôºã Add Night
        </button>

        <div className="table-scroll">
          <table>
            <thead>
              <tr>
                <th>Date / Night</th>
                <th>Place</th>
                <th>Cost / Night ($)</th>
                <th />
              </tr>
            </thead>
            <tbody>
              {lodging.map((n) => (
                <tr key={n.id}>
                  <td>
                    <input
                      type="date"
                      value={n.date}
                      onChange={(e) => updateNight(n.id, "date", e.target.value)}
                    />
                  </td>
                  <td>
                    <input
                      value={n.place}
                      onChange={(e) => updateNight(n.id, "place", e.target.value)}
                      placeholder="Cabin / Resort name"
                    />
                  </td>
                  <td>
                    <input
                      type="number"
                      min="0"
                      step="1"
                      value={n.cost}
                      onChange={(e) => updateNight(n.id, "cost", e.target.value)}
                      placeholder="0"
                    />
                  </td>
                  <td>
                    <button
                      className="btn-danger"
                      onClick={() => removeNight(n.id)}
                    >
                      ‚úï
                    </button>
                  </td>
                </tr>
              ))}
              {lodging.length === 0 && (
                <tr>
                  <td colSpan="4" style={{ textAlign: "center", color: "#94a3b8" }}>
                    Track each night and cost, even if it's a package deal.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
        <small className="help">
          If you're splitting a package, you can either enter nightly costs or the full package
          on one line.
        </small>
      </div>
    );
  }

  function BudgetCard({ trip }) {
    const players = trip.players || [];
    const rounds = trip.rounds || [];
    const lodging = trip.lodging || [];

    const { totalGreen, totalLodging, total, perPlayer } = useMemo(() => {
      const totalGreen = rounds.reduce((sum, r) => {
        const v = parseFloat(r.greenFee);
        return sum + (isNaN(v) ? 0 : v);
      }, 0);

      const totalLodging = lodging.reduce((sum, n) => {
        const v = parseFloat(n.cost);
        return sum + (isNaN(v) ? 0 : v);
      }, 0);

      const total = totalGreen + totalLodging;
      const headcount = players.length || 1;
      const perPlayer = total / headcount;

      return { totalGreen, totalLodging, total, perPlayer };
    }, [players, rounds, lodging]);

    return (
      <div className="card">
        <h3>
          <span className="label">Budget Summary</span>
          <span className="badge">
            <span style={{ width: 6, height: 6, borderRadius: 999, background: "#22c55e", marginRight: 4 }} />
            Live estimate
          </span>
        </h3>

        <div className="summary-line">
          <span className="label">Players</span>
          <span className="value">{players.length || 0}</span>
        </div>
        <div className="summary-line">
          <span className="label">Total Green Fees</span>
          <span className="value">${totalGreen.toFixed(0)}</span>
        </div>
        <div className="summary-line">
          <span className="label">Total Lodging</span>
          <span className="value">${totalLodging.toFixed(0)}</span>
        </div>
        <div className="summary-total summary-line">
          <span className="label">Trip Total</span>
          <span className="value">${total.toFixed(0)}</span>
        </div>
        <div className="summary-line">
          <span className="label">Estimated Per Player</span>
          <span className="value">
            {players.length > 0 ? `$${perPlayer.toFixed(0)}` : "Add players to see per-person"}
          </span>
        </div>
        <small className="help">
          This is just golf + lodging. Later we can add travel, food, skins/chips, and other extras.
        </small>
      </div>
    );
  }

  function ExportCard({ trip }) {
    const players = trip.players || [];
    const rounds = trip.rounds || [];
    const lodging = trip.lodging || [];

    function exportPlayers() {
      if (players.length === 0) {
        alert("No players to export.");
        return;
      }
      const headers = ["name", "handicap", "email", "notes"];
      const rows = players.map((p) => ({
        name: p.name,
        handicap: p.handicap,
        email: p.email,
        notes: p.notes
      }));
      downloadCSV(`${trip.name || "trip"}-players.csv`, headers, rows);
    }

    function exportRounds() {
      if (rounds.length === 0) {
        alert("No rounds to export.");
        return;
      }
      const headers = ["date", "course", "teeTime", "greenFee"];
      const rows = rounds.map((r) => ({
        date: r.date,
        course: r.course,
        teeTime: r.teeTime,
        greenFee: r.greenFee
      }));
      downloadCSV(`${trip.name || "trip"}-rounds.csv`, headers, rows);
    }

    function exportLodging() {
      if (lodging.length === 0) {
        alert("No lodging to export.");
        return;
      }
      const headers = ["date", "place", "cost"];
      const rows = lodging.map((n) => ({
        date: n.date,
        place: n.place,
        cost: n.cost
      }));
      downloadCSV(`${trip.name || "trip"}-lodging.csv`, headers, rows);
    }

    function exportJSONTrip() {
      downloadJSON(`${trip.name || "trip"}.json`, trip);
    }

    return (
      <div className="card">
        <h3>
          <span className="label">Exports & Backup</span>
          <span className="sub">Move data into Google Sheets or save JSON</span>
        </h3>
        <div className="field-row" style={{ flexWrap: "wrap", gap: "0.5rem" }}>
          <button className="btn-secondary" onClick={exportPlayers}>Export Players CSV</button>
          <button className="btn-secondary" onClick={exportRounds}>Export Rounds CSV</button>
          <button className="btn-secondary" onClick={exportLodging}>Export Lodging CSV</button>
          <button className="btn-secondary" onClick={exportJSONTrip}>Export Trip JSON</button>
        </div>
        <small className="help">
          In Google Sheets, use <strong>File ‚Üí Import ‚Üí Upload</strong> to pull in these CSVs as new sheets.
        </small>
      </div>
    );
  }

  function TeamsAndScoringCard({ trip, onChange }) {
    const players = trip.players || [];
    const rounds = trip.rounds || [];
    const teams = trip.teams || [];
    const scores = trip.scores || {};

    function updateTrip(partial) {
      onChange({ ...trip, ...partial });
    }

    // TEAMS
    function addTeam() {
      const id = Date.now().toString() + Math.random().toString(16).slice(2);
      const newTeams = [
        ...teams,
        { id, name: "New Team", color: "", playerIds: [] }
      ];
      updateTrip({ teams: newTeams });
    }

    function updateTeam(id, field, value) {
      const updatedTeams = teams.map((t) =>
        t.id === id ? { ...t, [field]: value } : t
      );
      updateTrip({ teams: updatedTeams });
    }

    function updateTeamPlayers(id, selectedIds) {
      const updatedTeams = teams.map((t) =>
        t.id === id ? { ...t, playerIds: selectedIds } : t
      );
      updateTrip({ teams: updatedTeams });
    }

    function removeTeam(id) {
      const updatedTeams = teams.filter((t) => t.id !== id);
      updateTrip({ teams: updatedTeams });
    }

    // SCORES
    function getScore(roundId, playerId) {
      return scores?.[roundId]?.[playerId]?.strokes || "";
    }

    function setScore(roundId, playerId, value) {
      const newScores = { ...(scores || {}) };
      if (!newScores[roundId]) newScores[roundId] = {};
      newScores[roundId] = {
        ...newScores[roundId],
        [playerId]: { strokes: value }
      };
      updateTrip({ scores: newScores });
    }

    // TEAM TOTALS
    const teamTotals = useMemo(() => {
      return teams.map((team) => {
        let total = 0;
        rounds.forEach((round) => {
          const roundScores = scores[round.id] || {};
          team.playerIds.forEach((pid) => {
            const raw = roundScores[pid]?.strokes;
            const num = parseFloat(raw);
            if (!isNaN(num)) total += num;
          });
        });
        return {
          id: team.id,
          name: team.name,
          color: team.color,
          playerCount: team.playerIds.length,
          totalStrokes: total
        };
      }).sort((a, b) => a.totalStrokes - b.totalStrokes);
    }, [teams, rounds, scores]);

    return (
      <div className="card">
        <h3>
          <span className="label">Teams & Scoring</span>
          <span className="sub">Assign players to teams and track scores</span>
        </h3>

        {/* Teams Editor */}
        <div style={{ marginBottom: "0.75rem" }}>
          <div className="field-row" style={{ justifyContent: "space-between", alignItems: "center" }}>
            <div style={{ fontSize: "0.82rem", color: "#cbd5e1" }}>
              Teams ({teams.length})
            </div>
            <button className="btn-secondary" onClick={addTeam}>Ôºã Add Team</button>
          </div>

          <div className="table-scroll" style={{ maxHeight: 170 }}>
            <table>
              <thead>
                <tr>
                  <th>Team Name</th>
                  <th>Color / Label</th>
                  <th>Players</th>
                  <th />
                </tr>
              </thead>
              <tbody>
                {teams.map((t) => (
                  <tr key={t.id}>
                    <td>
                      <input
                        value={t.name}
                        onChange={(e) => updateTeam(t.id, "name", e.target.value)}
                        placeholder="Team name"
                      />
                    </td>
                    <td>
                      <input
                        value={t.color}
                        onChange={(e) => updateTeam(t.id, "color", e.target.value)}
                        placeholder="e.g. Green, Blue"
                      />
                    </td>
                    <td>
                      <select
                        multiple
                        value={t.playerIds}
                        onChange={(e) => {
                          const selected = Array.from(e.target.selectedOptions).map(
                            (opt) => opt.value
                          );
                          updateTeamPlayers(t.id, selected);
                        }}
                        style={{ minHeight: "2.2rem" }}
                      >
                        {players.map((p) => (
                          <option key={p.id} value={p.id}>
                            {p.name || "Unnamed"}
                          </option>
                        ))}
                      </select>
                    </td>
                    <td>
                      <button className="btn-danger" onClick={() => removeTeam(t.id)}>‚úï</button>
                    </td>
                  </tr>
                ))}
                {teams.length === 0 && (
                  <tr>
                    <td colSpan="4" style={{ textAlign: "center", color: "#94a3b8" }}>
                      Add teams and assign players to set up team scoring.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
          <small className="help">
            Use Ctrl/Cmd-click in the players list to select multiple players for a team.
          </small>
        </div>

        {/* Scores per round */}
        <div style={{ marginTop: "0.75rem" }}>
          <div style={{ fontSize: "0.82rem", color: "#cbd5e1", marginBottom: "0.35rem" }}>
            Scores (total strokes per round)
          </div>
          {rounds.length === 0 || players.length === 0 ? (
            <div style={{ fontSize: "0.8rem", color: "#94a3b8" }}>
              Add at least one round and one player to start tracking scores.
            </div>
          ) : (
            <div className="table-scroll" style={{ maxHeight: 220 }}>
              <table>
                <thead>
                  <tr>
                    <th>Round</th>
                    {players.map((p) => (
                      <th key={p.id}>{p.name || "Player"}</th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {rounds.map((r) => (
                    <tr key={r.id}>
                      <td>
                        {(r.date || "") + (r.course ? ` ¬∑ ${r.course}` : "")}
                      </td>
                      {players.map((p) => (
                        <td key={p.id}>
                          <input
                            type="number"
                            min="0"
                            step="1"
                            value={getScore(r.id, p.id)}
                            onChange={(e) => setScore(r.id, p.id, e.target.value)}
                            placeholder="‚Äì"
                          />
                        </td>
                      ))}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>

        {/* Scoreboard */}
        <div style={{ marginTop: "0.75rem" }}>
          <div style={{ fontSize: "0.82rem", color: "#cbd5e1", marginBottom: "0.35rem" }}>
            Team Scoreboard (lower total is better)
          </div>
          <div className="table-scroll" style={{ maxHeight: 150 }}>
            <table className="scoreboard-table">
              <thead>
                <tr>
                  <th>Team</th>
                  <th>Color</th>
                  <th>Players</th>
                  <th>Total Strokes</th>
                </tr>
              </thead>
              <tbody>
                {teamTotals.length === 0 ? (
                  <tr>
                    <td colSpan="4" style={{ textAlign: "center", color: "#94a3b8" }}>
                      Create teams and enter scores to see the leaderboard.
                    </td>
                  </tr>
                ) : (
                  teamTotals.map((t) => (
                    <tr key={t.id}>
                      <td>{t.name}</td>
                      <td>{t.color}</td>
                      <td>{t.playerCount}</td>
                      <td>{t.totalStrokes || 0}</td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    );
  }

  function App() {
    const [trips, setTrips] = useState(() => loadTripsFromStorage());
    const [selectedId, setSelectedId] = useState(() => {
      const stored = loadTripsFromStorage();
      return stored[0]?.id || null;
    });

    useEffect(() => {
      saveTripsToStorage(trips);
      if (trips.length > 0 && !selectedId) {
        setSelectedId(trips[0].id);
      }
    }, [trips, selectedId]);

    const selectedTrip = trips.find((t) => t.id === selectedId) || null;

    function handleAddTrip() {
      const newTrip = createNewTrip();
      setTrips((prev) => [...prev, newTrip]);
      setSelectedId(newTrip.id);
    }

    function handleDeleteTrip(id) {
      setTrips((prev) => prev.filter((t) => t.id !== id));
      if (id === selectedId) {
        const remaining = trips.filter((t) => t.id !== id);
        setSelectedId(remaining[0]?.id || null);
      }
    }

    function updateTrip(updated) {
      setTrips((prev) => prev.map((t) => (t.id === updated.id ? updated : t)));
    }

    function duplicateTrip() {
      if (!selectedTrip) return;
      const newId = Date.now().toString();
      const clone = {
        ...selectedTrip,
        id: newId,
        name: selectedTrip.name + " (Copy)"
      };
      setTrips((prev) => [...prev, clone]);
      setSelectedId(newId);
    }

    return (
      <div className="app">
        <Sidebar
          trips={trips}
          selectedId={selectedId}
          onSelectTrip={setSelectedId}
          onAddTrip={handleAddTrip}
          onDeleteTrip={handleDeleteTrip}
        />
        <main className="main">
          {!selectedTrip ? (
            <div className="empty-state">
              <p>
                Create your first trip to start planning. You‚Äôll be able to add players, rounds,
                lodging, teams, and see a live budget estimate.
              </p>
            </div>
          ) : (
            <>
              <div className="main-header">
                <div className="main-header-left">
                  <h2>{selectedTrip.name || "Untitled Trip"}</h2>
                  <p>
                    {selectedTrip.destination || "Destination TBA"} ¬∑{" "}
                    {selectedTrip.startDate || "?"} ‚Üí {selectedTrip.endDate || "?"}
                  </p>
                </div>
                <div style={{ display: "flex", gap: "0.5rem", alignItems: "center", flexWrap: "wrap" }}>
                  <span className="pill">
                    <span className="dot" /> Auto-saved locally
                  </span>
                  <button className="btn-secondary" onClick={duplicateTrip}>
                    ‚ßâ Duplicate Trip
                  </button>
                </div>
              </div>

              <div className="grid">
                <BasicInfo trip={selectedTrip} onChange={updateTrip} />
                <BudgetCard trip={selectedTrip} />
              </div>

              <div className="grid">
                <PlayersCard trip={selectedTrip} onChange={updateTrip} />
                <RoundsCard trip={selectedTrip} onChange={updateTrip} />
              </div>

              <div className="grid">
                <LodgingCard trip={selectedTrip} onChange={updateTrip} />
                <ExportCard trip={selectedTrip} />
              </div>

              <div className="grid">
                <TeamsAndScoringCard trip={selectedTrip} onChange={updateTrip} />
              </div>
            </>
          )}
        </main>
      </div>
    );
  }

  const root = ReactDOM.createRoot(document.getElementById("root"));
  root.render(<App />);
</script>
</body>
</html>
